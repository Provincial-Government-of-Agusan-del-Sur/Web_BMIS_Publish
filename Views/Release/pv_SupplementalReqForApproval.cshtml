
<script>
    function getParam() {
        var programid=$("#Program_supplemental_null").val() =="" ? 0 : $("#Program_supplemental_null").val()
        var accountid= $("#account_list_supplemental_null").val()==""? 0 : $("#account_list_supplemental_null").val()
        return {
            office:'@Session["office"]',
            programid:programid,
            accountid:accountid,
            status:6,
            yearof : $("#tyear").val(),
            monthof:$("#Months_supplemental_null").val()
        }
    }
    function returnsupplemental(trnno) {
        swal({
            title: "W A R N I N G!",
            text: "Return this transaction?",
            type: "warning",
            showCancelButton: true,
            confirmButtonColor: "#DD6B55",
            confirmButtonText: "Yes",
            closeOnConfirm: false
        }, function () {
            var url = "@Url.Action("returnsupplemental", "Release")";
            $.get(url, { trnno: trnno }, function (e) {
                if (e == "success") {
                    swal("Success!", "Successfully returned!", "success");
                    $("#grd_supplemental_approve").data("kendoGrid").dataSource.read();
                } else {
                    swal("Error!", e, "error");
                    $("#grd_supplemental_approve").data("kendoGrid").dataSource.read();
                }
            });
        });
    }
    function disapprovesupplemental(trnno){
        swal({
            title: "W A R N I N G!",
            text: "Disapprove this transaction?",
            type: "warning",
            showCancelButton: true,
            confirmButtonColor: "#DD6B55",
            confirmButtonText: "Yes",
            closeOnConfirm: false
        }, function () {
            var url = "@Url.Action("disapprovesupplemental", "Release")";
            $.get(url, { trnno: trnno }, function (e) {
                if (e == "success") {
                    swal("Success!", "Successfully disapproved!", "success");
                    $("#grd_supplemental_approve").data("kendoGrid").dataSource.read();
                } else {
                    swal("Error!", e, "error");
                    $("#grd_supplemental_approve").data("kendoGrid").dataSource.read();
                }
            });
        });
    }
    function frmclose() {
        $("#dffptsubmitted").data("kendoWindow").close();
    }
    function searchPrep() {
        var $filter = new Array();
        $filter = [];

        if ($('#searchPrep').val().length > 0) {
            $filter.push({ field: "AccountName", operator: "contains", value: $('#searchPrep').val() }),
            $filter.push({ field: "MonthOf", operator: "contains", value: $('#searchPrep').val() }),
            $filter.push({ field: "subaccountname", operator: "contains", value: $('#searchPrep').val() })
        }

        $('#grd_supplemental_approve').data('kendoGrid').dataSource.filter({
            logic: "or",
            filters: $filter
        });

    }

    $(function () {
        $("#searchPrep").keypress(function (e) {
            if (e.keyCode == 13) {
                searchPrep();
            }
        });
    });
    function fnSupReportHistory() {
        return {
            officeid: $("#office_supplemental_req").val(),
            monthof: $("#Months_supplemental_null").val()
        }
    }
    function onDataBound(e) {
        $(".k-hierarchy-cell").hide();
        $(".k-hierarchy-col").hide();
        var grid = $("#grd_supplemental_approve").data("kendoGrid")
        var ds = grid.dataSource.view();
        var rows = e.sender.tbody.children();

        for (var i = 0; i < ds.length; i++) {
            supplementalbudget_id = ds[i].supplementalbudget_id;

            var row = $(rows[i]);
            // ds[i].AmountApprove == 0

            if (@Account.UserInfo.UserTypeID != 4 ) {
                $('#returnid' + supplementalbudget_id + '').css("display", "none");
                grid.hideColumn('returnid'+ supplementalbudget_id + '');
                $('#disapprove' + supplementalbudget_id + '').css("display", "none");
                grid.hideColumn('disapprove'+ supplementalbudget_id + '');
            //    $('#postsupplementalid').css("display", "none");
            }
            if (ds[i].status == 5){
                $('#disapprove' + supplementalbudget_id + '').css("display", "none");
                grid.hideColumn('disapprove'+ supplementalbudget_id + '');
            }
            else if (ds[i].status==6){
                $('#returnid' + supplementalbudget_id + '').css("display", "none");
                grid.hideColumn('returnid'+ supplementalbudget_id + '');
            }

            if (ds[i].AmountApprove == 0 || @Account.UserInfo.UserTypeID != 4) {
                $('#check' + supplementalbudget_id + '').css("display", "none");
                $('#checkallid').css("display", "none");
            }
            else {
                $('#check' + supplementalbudget_id + '').css("display", "normal");
             //   $('#postsupplementalid').css("display", "none");
            }
        }
    }
    function CheckAll(e) {
        $("#grd_supplemental_approve tbody input:checkbox").prop("checked", e.checked);
    }
    function WFPgrid() {

        var entityGrid = $("#grd_supplemental_approve").data("kendoGrid");
        var selectedItem = entityGrid.dataItem(entityGrid.select());

        if (selectedItem.AmountApprove == 0){
            $("#appovenewamount").val(selectedItem.Amount)
        }
        else{
            $("#appovenewamount").val(selectedItem.AmountApprove)
        }
        $("#t_supplementalid").val(selectedItem.supplementalbudget_id)
    }
</script>
<div id="searchAccountid" style="height: 30px; margin-top: 0px; float: right; margin-left: 200px;">
    <input type="text" style="width:406px;border-collapse:collapse;margin:0px;border-style:solid;margin-left:0px;height:70%;outline:none;font-family:'Segoe UI Light_','Open Sans Light',Verdana,Arial,Helvetica,sans-serif;float:left;" placeholder="Search..." id="searchPrep" name="searchPrep">
    <div class="k-button k-button-icontext" style="height:30px;width:40px;border-style:solid;" onclick="searchPrep()"><span class="mif-search"></span></div>
</div>
<div class="fa fa-re" style="width:100%;">
    @(Html.Kendo().Grid<iFMIS_BMS.BusinessLayer.Models.Monthly_DD_Model>()
    .Name("grd_supplemental_approve")
    .Columns(col =>
    {
    col.Template(@<text></text>)
                .ClientTemplate("<input id='check#=supplementalbudget_id#' type='checkbox' class='checkbox'/>")
                //.ClientTemplate(
                //    "# if('@Account.UserInfo.UserTypeID.toString()' == 4') { #" +
                //    "<input type='checkbox' class='checkbox'/>" +
                //    "# } #"
                //)
                .Title("<input id='checkallid' onclick=CheckAll(this) type='checkbox'  class='checkbox'/>")
                .Width(25)
                .HtmlAttributes(new { @onclick = "click", style = "align:center;float:none;text-align:center; vertical-align: middle;" })
                .HeaderHtmlAttributes(new { style = "text-align:center; vertical-align: middle; overflow: visible; white-space: normal" });
    col.Bound(m => m.AccountName).HtmlAttributes(new { style = "text-align:left;height:30px" })
                    .HeaderTemplate(@<text><div style="font-weight:600;text-align:center; vertical-align: middle; overflow: visible; white-space: normal;">Account</div></text>)
                        .Width(120)
                        .HeaderHtmlAttributes(new { style = "text-align:left; vertical-align: middle; overflow: visible; white-space: normal" })
                        .ClientFooterTemplate("<div style='text-align:right;color:darkgreen'><label> Total :</label></div>");
    col.Bound(m => m.subaccountname).HtmlAttributes(new { style = "text-align:left;height:30px" })
                    .HeaderTemplate(@<text><div style="font-weight:600;text-align:center; vertical-align: middle; overflow: visible; white-space: normal;">Sub-Account</div></text>)
                .Width(120)
                .HeaderHtmlAttributes(new { style = "text-align:left; vertical-align: middle; overflow: visible; white-space: normal" });
    //    .ClientFooterTemplate("<div style='text-align:right;color:darkgreen'><label> Total :</label></div>");
    col.Bound(m => m.Amount)
                .HtmlAttributes(new { style = "text-align:right;height:30px" })
                .HeaderTemplate(@<text><div style="font-weight:600;text-align:center; vertical-align: middle; overflow: visible; white-space: normal;">Amount<br />(Requested)</div></text>)
                    .Width(60)
                    .HeaderHtmlAttributes(new { style = "text-align:center; vertical-align: middle; overflow: visible; white-space: normal" })
                    .ClientTemplate("<div>#=kendo.toString(Amount,'c2')# </div>")
                    .ClientFooterTemplate("<div style='text-align:right;color:darkgreen'><label> </label><label> #=kendo.toString(sum, 'c2')#</label></div>");
    col.Bound(m => m.AmountApprove)
                .HtmlAttributes(new { style = "text-align:right;height:30px" })
                .HeaderTemplate(@<text><div style="font-weight:600;text-align:center; vertical-align: middle; overflow: visible; white-space: normal;">Amount<br />(Approved)</div></text>)
                    .Width(60)
                    .HeaderHtmlAttributes(new { style = "text-align:center; vertical-align: middle; overflow: visible; white-space: normal" })
                    .ClientTemplate("<div>#=kendo.toString(AmountApprove,'c2')# </div>");
                //    .ClientFooterTemplate("<div style='text-align:right;color:darkgreen'><label> </label><label> #=kendo.toString(sum, 'c2')#</label></div>");
    col.Bound(m => m.MonthOf).HtmlAttributes(new { style = "text-align:center;height:30px" })
                    .HeaderTemplate(@<text><div style="font-weight:600;text-align:center; vertical-align: middle; overflow: visible; white-space: normal;">Month</div></text>)
                    .Width(60)
                    .HeaderHtmlAttributes(new { style = "text-align:center; vertical-align: middle; overflow: visible; white-space: normal" });
    col.Bound(m => m.YearOf).HtmlAttributes(new { style = "text-align:center;height:30px" })
                    .HeaderTemplate(@<text><div style="font-weight:600;text-align:center; vertical-align: middle; overflow: visible; white-space: normal;">Year</div></text>)
                    .Width(30)
                    .HeaderHtmlAttributes(new { style = "text-align:center; vertical-align: middle; overflow: visible; white-space: normal" });

    col.Template(t => { }).ClientTemplate(
                        "<div class='k-button k-button-icontext' id='disapprove#=supplementalbudget_id#' style='border-radius:70px;background-color:indianred;color:white'   onclick='disapprovesupplemental(#=supplementalbudget_id#)'   ><span class='fa fa-thumbs-down' style='font-size: 10pt;margin: 1px;margin-top: -1px;margin-left: 5px;margin-right: 3px;'> </span>Disapprove</div>"
        ).HtmlAttributes(new { style = "vertical-align: middle;" }).Width(75);

    col.Bound(m => m.supplementalbudget_id).HtmlAttributes(new { style = "text-align:left;height:30px" })
                    .HeaderTemplate(@<text><div style="font-weight:600;text-align:center; vertical-align: middle; overflow: visible; white-space: normal;">ID</div></text>)
                    .Hidden()
                    .HeaderHtmlAttributes(new { style = "text-align:center; vertical-align: middle; overflow: visible; white-space: normal" });
    col.Bound(m => m.subaccount).HtmlAttributes(new { style = "text-align:left;height:30px" })
                    .HeaderTemplate(@<text><div style="font-weight:600;text-align:center; vertical-align: middle; overflow: visible; white-space: normal;">Sub-Account ID</div></text>)
                    .Hidden()
                    .HeaderHtmlAttributes(new { style = "text-align:center; vertical-align: middle; overflow: visible; white-space: normal" });
    col.Bound(m => m.status).HtmlAttributes(new { style = "text-align:left;height:30px" })
                    .HeaderTemplate(@<text><div style="font-weight:600;text-align:center; vertical-align: middle; overflow: visible; white-space: normal;">Status</div></text>)
                    .Hidden()
                    .HeaderHtmlAttributes(new { style = "text-align:center; vertical-align: middle; overflow: visible; white-space: normal" });
    })
    .ToolBar(toolbar =>
    {
        toolbar.Custom().Text("<div id='postsupplementalid'> <span id='spanthumbsup' class='fa fa-save'> </span><span id='SpanOnApproveProgress' style='display:none' class='fa fa-spinner fa-spin'></span>  Post Supplemental </div>").Name("btnApprove").Url("javascript:void(0)").HtmlAttributes(new { onclick = "fn_approvesupple()" });
        // toolbar.Save();
    })
        // .Sortable()
        .Scrollable()
        .Selectable()
        .HtmlAttributes(new { style = "height:350px;" })
        .Pageable(pageable => pageable
        .Refresh(true)
        .ButtonCount(3))
        .Events(e => e.DataBound("onDataBound").Change("WFPgrid"))
        .DataSource(d => d
        .Ajax()
        .Batch(true)
        .Aggregates(a =>
        {
            a.Add(c => c.Amount).Sum();
        })
        .PageSize(1000)
        .Model(m => m.Id(i => i.supplementalbudget_id))
        .Read(read => read.Action("GetSupplementlist", "Release").Data("getParam")))
    )
</div>
<div style="clear:both"></div>
<div id="div_legalbasisid" style="float:left;margin-left:46.5px;margin-top:15px;">
    <label id="suplegalabelid" style="float:left;margin-left:75px;">
        Legal Basis :
    </label>
    <div id="suplegalbasisid" style="float:left;margin-left:24px; margin-top:0px;">
        @(Html.Kendo().ComboBox()
            .Name("legalbasis_supplemental_approve")
            .DataTextField("LegalDescription")
            .DataValueField("LegalCode")
            .Placeholder("Select Legal Basis...")
            .Filter("contains")
            .MinLength(1)
            .HtmlAttributes(new { @style = "width: 500px;" })
            .DataSource(source => source.Read(read => read.Action("GetLegalBasis", "Release")))
        )
    </div>
</div>
<div style="float: left;margin-right:10px;margin-top:15px;">
    <label style="float:left;margin-left: 75px;">
        Approve Amount   :
    </label>
    <div style="float:left;margin-left:25px;margin-top:0px;">
        <input type="number" id="appovenewamount" value="0" style="width:338px;"/>
    </div>
</div>
<div style="float:right;margin-right:764.4px;margin-top:20px;width:170px;">
    <label style="float:left;margin-left: 50px;">
        MAF History   :
    </label>
</div>

<div style="float:left;margin-left:232px;width:350px;margin-top:-30px;">
    @(Html.Kendo().ComboBox()
                    .Name("approverepHistory")
                    .DataTextField("datetime")
                    .DataValueField("mafid")
                    .SelectedIndex(-1)
                    .Filter("contains")
                    .MinLength(3)
                    .HtmlAttributes(new { style = "width:100%; height:100%", @class = "form-control autoselect" })
                    .DataSource(source => source.Read(read => read.Action("GetReportSupplementalHistory", "Report").Data("fnSupReportHistory")))
    )
</div>
<div style="float:right;margin-top:25px;width:550px;margin-right:-5px">
    <div class="k-button k-button-icontext" style="bottom: 15px; right: 25px;width: 100px;border-radius:50px;margin-left:5px" onclick="frmclear()"><span class='fa fa-eraser'></span> Clear</div>
    <div class="k-button k-button-icontext" style="bottom:15px; right:25px;width :90px; border-radius:50px;margin-left:5px;background-color:cornflowerblue;color:white;" onclick="frmsuppleupdate_approve()"><span class="fa fa-edit"></span> Update</div>
    <div class="k-button k-button-icontext" style="bottom:15px; right:25px;width :90px; border-radius:50px;margin-left:5px;background-color:cornflowerblue;color:white" onclick="fn_reqPreview()"><span class='fa fa-print' style='font-size: 10pt;margin: 1px;margin-top: -1px;margin-left: 5px;margin-right: 3px;'></span> Preview</div>
    <div class="k-button k-button-icontext"  style="bottom: 15px; right: 25px;width: 100px;background-color:indianred; color:white;border-radius:50px;margin-left:5px" onclick="frmclose()"><span class="fa fa-close"></span> Close</div>
</div>

<div style="display:none">
    <input type="number" id="t_supplementalid" value="0"/>
</div>
<script>

    $(document).ready(function(){
        $("#grd_supplemental_approve").data("kendoGrid").dataSource.read();
        $("#approverepHistory").data("kendoComboBox").dataSource.read();
        if (@Account.UserInfo.UserTypeID != 4) { //super admin

            //document.getElementById("approveid").style.display = "none";
            //document.getElementById("suplegalabelid").style="display:none"
            document.getElementById("div_legalbasisid").style="display:none"
            document.getElementById("postsupplementalid").style="display:none"
        }
        else{
            document.getElementById("div_legalbasisid").style="float:left;margin-left:46.5px;margin-top:15px;"
            //document.getElementById("suplegalbasisid").style="display:normal;float:left;margin-left:50px;margin-top:0px;"
            document.getElementById("postsupplementalid").style="display:normal"
        }

    });
    function frmsuppleupdate_approve(){
        var suppid=$("#t_supplementalid").val();
        var approveamount=$("#appovenewamount").val();
        var url="@Url.Action("updatesuppamount","Release")"

        $.post(url, { supid: suppid,amount:approveamount}, function (d) {
            swal({ title: "Success!", text: d, timer: 2500, showConfirmButton: false, type: "success" });
            $("#grd_supplemental_approve").data("kendoGrid").dataSource.read();
        });
    }

    function fn_approvesupple() {
        var url = "@Url.Action("approvesupplemental", "Release")";
        var idsToSend = [];
        var grid = $("#grd_supplemental_approve").data("kendoGrid")
        var ds = grid.dataSource.view();
        var officeid = $("#office_supplemental_req").val() == "" ? 0 : $("#office_supplemental_req").val();
        var accountid = $("#Program_supplemental_null").val() == "" ? 0 : $("#Program_supplemental_null").val();

        if (@Account.UserInfo.UserTypeID == 4 ) {
            for (var i = 0; i < ds.length; i++) {
                var row = grid.table.find("tr[data-uid='" + ds[i].uid + "']");
                var checkbox = $(row).find(".checkbox");
                if (checkbox.is(":checked")) {
                    idsToSend.push(ds[i].supplementalbudget_id);
                }
            }
            if (idsToSend == "") {
                swal({ title: "Warning!", text: "Please tick the checkbox beside the account first!", timer: 2500, showConfirmButton: false, type: "warning" });
            }
            else if ($("#legalbasis_supplemental_approve").data("kendoComboBox").text() == ""){
                swal({ title: "Warning!", text: "Please select Legal Basis!", timer: 2500, showConfirmButton: false, type: "warning" });
            }
            else {
                swal({
                    title: "Are you sure?",
                    text: "Approved amount will be posted as supplemental budget! Do you want to proceed?",
                    type: "info",
                    showCancelButton: true,
                    closeOnConfirm: false,
                    confirmButtonColor: "#1fa67a",
                    confirmButtonText: "Yes!",
                    showLoaderOnConfirm: true,
                }, function () {

                    $.post(url, { sup_id: idsToSend,legalbasis:$("#legalbasis_supplemental_approve").val() }, function (d) {
                        if (d == 'success') {
                            swal({ title: "Success!", text: "Supplemental amount has been posted!", timer: 2500, showConfirmButton: false, type: "success" });
                            $("#grd_supplemental_approve").data("kendoGrid").dataSource.read();
                        }
                        else {
                            swal("Something Went Wrong!", d, "error");
                        }
                    });
                });
            }
        }
    }
    function fn_reqPreview(){
        var program_id = $('#Program_supplemental_null').val() == ""? 0: $('#Program_supplemental_null').val()
        var accountid=$("#account_list_supplemental_null").val() ==""? 0: $("#account_list_supplemental_null").val()
        var yearof = $("#tyear").val()
        var office=$('#office_supplemental_req').data("kendoComboBox").text()
        var officeid=$('#office_supplemental_req').val()
        var approverepHistory=$('#approverepHistory').val() == ""? 0: $('#approverepHistory').val()
        if ((program_id ==0 || accountid == 0)  && approverepHistory == 0){
            swal("Warning","Please select office, program and account respectively!","warning")
        }
        else{
            $.ajax({
                async: false,
                dataType: 'html',
                success: window.open("../Reports/ReportViewer.aspx?rid=39&programID=" + program_id + "&accountID=" + accountid + "&yearof=" + yearof + "&OfficeName="+ office +"&OfficeID="+ officeid +"&mode=1&approverepHistory="+ approverepHistory +"&source=0")
            });
        }
    }

    function frmclose() {
        $("#supleforapproval").data("kendoWindow").close();
    }
    function frmclear(){
        $("#t_supplementalid").val(0)
        $("#appovenewamount").val(0)
        $("#legalbasis_supplemental_approve").data("kendoComboBox").value("")
        $("#approverepHistory").data("kendoComboBox").value("")
    }
</script>