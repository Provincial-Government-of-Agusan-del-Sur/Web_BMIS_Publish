<script>

    function CheckAllFS(e) {
        $("#grd_BudgetApprovalBudgetFS tbody input:checkbox").prop("checked", e.checked);
    }

    function btnApproveFS() {
        var url = "@Url.Action("ApproveProposal", "Home")";
        var idsToSend = [];
        var AmountsToSend = [];
        var BudgetToSend = [];
        var grid = $("#grd_BudgetApprovalBudgetFS").data("kendoGrid")
        var ds = grid.dataSource.view();

        for (var i = 0; i < ds.length; i++) {
            var row = grid.table.find("tr[data-uid='" + ds[i].uid + "']");
            var checkbox = $(row).find(".checkbox");
            if (checkbox.is(":checked")) {
                idsToSend.push(ds[i].ProposalID); //loops
                AmountsToSend.push(ds[i].ProposalAmmount)
                BudgetToSend.push(ds[i].SlashAmount);
            }
        }
        if (idsToSend == "") {
            swal({ title: "Error!", text: "Please mark the accounts first", timer: 1000, showConfirmButton: false, type: "error" });
        } else {
            $.post(url, { ProposalID: idsToSend, ProposedAmounts: AmountsToSend, SlashAmount: BudgetToSend }, function (d) {
                if (d == 1) {
                    swal({ title: "Success!", text: "Selected Accounts Approved!", timer: 1000, showConfirmButton: false, type: "success" });
                    $("#grd_BudgetApprovalBudgetFS").data("kendoGrid").dataSource.read();
                }
                else {
                    swal("Something Went Wrong!", d, "error");
                }
            })
        }
    }

    function ViewHistoryFS(ProposalID) {
        $(window).scrollTop(0);
        var gridName = $('#grd_BudgetApprovalBudgetFS').data('kendoGrid');
        var dataRows = gridName.items();
        var rowIndex = dataRows.index(gridName.select());
        var ds = gridName.dataSource.view();
        var AccountName = ds[rowIndex].AccountName;
        var ProposalAmount = ds[rowIndex].ProposalAmmount;
        var url = "@Url.Action("ViewHistoryAmount", "Home")";
        $.get(url, { ProposalID: ProposalID, AccountName: AccountName, ProposalAmount: ProposalAmount }, function (d) {
            document.documentElement.style.overflow = 'hidden';  // firefox, chrome
            document.body.scroll = "no";
            $('#ViewHistoryAmount').html(d);
        })
        $('#ViewHistoryAmount').data('kendoWindow').title("<i class='fa fa-navicon'> </i> Slashing Amount History").center().open();
    }

    function viewComputationFS(AccountCode) {

        var gridName = $('#grd_BudgetApprovalBudgetFS').data('kendoGrid');
        var dataRows = gridName.items();
        var rowIndex = dataRows.index(gridName.select());
        var ds = gridName.dataSource.view();
        var ProposalID = ds[rowIndex].ProposalID;
        var url = "@Url.Action("CheckComputationDetails", "BudgetPreparation")";
        var url1 = "@Url.Action("getrefYear", "BudgetPreparation")";
        var AccountID = AccountCode;
        var ProposalYear = $("#ddlYear").val();
        var AccountName = ds[rowIndex].AccountName;
        //var OfficeID = @Account.UserInfo.Department;
        var OfficeID = $("#offs").val();
        if (AccountID == 0) {
            var isCasual = "";
            if (AccountName == "Proposed Casual") {
                isCasual = "Yes";
            }
            else {
                isCasual = "No";
            }
            var url2 = "@Url.Action("viewForFundingDetails", "Home")";
            $.post(url2, {isCasual: isCasual }, function (d) {
                $(window).scrollTop(0);
                $('#ForFundingDetail').html(d);
                $('#ForFundingDetail').data('kendoWindow').title("<i class='fa fa-navicon'> </i> For Funding Details").center().open();
            })
        }
        else {
            $('#ComputationDetails').html('<div style="width: 100%;height:100%;"><img src="@Url.Content("~/Content/images/loading.gif")" alt="Loading..." style="position: absolute;top: 20%;left: 30%;margin-top: 0px;margin-left: 0px;" /></div>');
            $.post(url1, { ProposalID: ProposalID }, function (refYearValue) {
                if (refYearValue == 0) {
                    swal({ title: "Notice!", text: "No Computation Available in this Account!", timer: 1000, showConfirmButton: false, type: "info" });
                }
                else {
                    $.post(url, { AccountID: AccountID, refYear: refYearValue }, function (d) {
                        if (d == AccountID) {

                            $(window).scrollTop(0);
                            var url2 = "@Url.Action("viewComputationDetails", "BudgetPreparation")";
                            $.get(url2, { AccountID: AccountID, OfficeID: OfficeID, refYear: refYearValue, ProposalYear: ProposalYear }, function (pvData) {
                                $('#ComputationDetails').html(pvData);
                            })
                            $('#ComputationDetails').data('kendoWindow').title("<i class='fa fa-navicon'> </i> Computation Details").center().open();
                        }
                        else {
                            swal({ title: "Notice!", text: "No Computation Available in this Account!", timer: 1000, showConfirmButton: false, type: "info" });
                        }
                    })
                }
            })
        }
    }
</script>

@(Html.Kendo().Grid<iFMIS_BMS.BusinessLayer.Models.AccountsModel>()
    .Name("grd_BudgetApprovalBudgetFS")
    .HtmlAttributes(new { style = "height:530px" })
    .Scrollable()
    .Columns(col =>
    {

        col.Template(@<text></text>)
                        .ClientTemplate("<input type='checkbox' class='checkbox'/>")
                        .Title("<input onclick=CheckAllFS(this) type='checkbox'   class='checkbox'/>")
                        .Width(30)
                        .HtmlAttributes(new { @onclick = "click", style = "align:center;float:none;text-align:center; font-size:12px; vertical-align: middle;" })
                        .HeaderHtmlAttributes(new { style = "text-align:center; vertical-align: middle; overflow: visible; white-space: normal" });
        col.Template(@<text></text>)
                        .HeaderTemplate(@<text><div style="font-weight:600;">Accounts</div></text>)
                        .Width(270)
                        .HtmlAttributes(new { style = "text-align:left;height:30px" })
                        .HeaderHtmlAttributes(new { style = "text-align:center; vertical-align: middle; overflow: visible; white-space: normal" })
                        .ClientTemplate("# if(ProposalStatusInCharge == 1) { #" +
                                               "# if(setRemarks != '') { #" +
                                               "<span class='fa fa-circle' style='color:red;' id='circle-id'></span> <span style='color:red;'> #=kendo.toString(AccountName)# </span> " +
                                               "# } else { #" +
                                               " <span class='fa fa-circle' style='color:red;' id='circle-id'></span> #=kendo.toString(AccountName)#" +
                                               "# }#" +
                                           "# } else { #" +
                                           "#=kendo.toString(AccountName)#" +
                                           "# } #");
        col.Template(@<text></text>)
                        .HeaderTemplate(@<text><div style="font-weight:600;">Account Code</div></text>)
                        .Width(80)
                        .HtmlAttributes(new { style = "text-align:center;height:30px" })
                        .HeaderHtmlAttributes(new { style = "text-align:center; vertical-align: middle; overflow: visible; white-space: normal;" })
                        .ClientTemplate("<div>#=AccountCode# </div>");

        col.Template(@<text></text>)
                        .HtmlAttributes(new { style = "text-align:right;height:30px" }).HeaderTemplate(@<text><div style="font-weight:600;text-align:center; vertical-align: middle; overflow: visible; white-space: normal;">Past Year <br /><span id="actualYearApprovalBudgetFS"></span> <br /> (Actual)</div></text>)
                        .Width(120)
                        .HeaderHtmlAttributes(new { style = "text-align:center; vertical-align: middle; overflow: visible; white-space: normal" })
                        .ClientTemplate("<div>#=kendo.toString(PastYear,'c2')# </div>");

        col.Template(@<text></text>)
                        .HeaderTemplate(@<text><div style="font-weight:600;text-align:center; vertical-align: middle; overflow: visible; white-space: normal;">Current Year <br /><span id="estimatesYearApprovalBudgetFS"></span>  <br /> (Estimates)</div></text>)
                        .Width(120)
                        .HtmlAttributes(new { style = "text-align:right;height:30px" })
                        .HeaderHtmlAttributes(new { style = "text-align:center; vertical-align: middle; overflow: visible; white-space: normal" })
                        .ClientTemplate("<div>#=kendo.toString(PastProposalAmmount,'c2')# </div>");

        col.Bound(m => m.ProposalID).Title("ProposalID").Hidden();
        col.Bound(m => m.AccountID).Title("Account").Hidden();
        col.Bound(m => m.ProgramID).Title("Program").Hidden();
        col.Bound(m => m.ProposalStatusHR).Title("HR").Hidden();
        col.Bound(m => m.ProposalStatusInCharge).Title("Budget Office").Hidden();
        col.Bound(m => m.ProposalStatusCommitteeINT).Title("Budget Committe").Hidden();
        col.Bound(m => m.ProposalDenominationCode).Title("Code").Hidden();
        col.Bound(m => m.ProposalAmmount).Title("Proposal Amount").Hidden();

        col.Bound(m => m.CheckComp).Title("CheckComp").Hidden();
        col.Bound(m => m.OOEID).Title("OOEID").Hidden();
        col.Bound(m => m.SelectedOfficeID).Title("Office ID").Hidden();
        if (ViewBag.UserType != "Budget Committee / Local Finance Committee")
        {
            col.Template(@<text></text>).HtmlAttributes(new { style = "text-align:right;height:30px;" }).HeaderTemplate(@<text><div style="font-weight:600;text-align:center; vertical-align: middle; overflow: visible; white-space: normal;">Budget Year<br /> <span id="proposedYearApprovalBudgetFS"></span><br /> (Proposed)</div></text>)
                                       .HeaderHtmlAttributes(new { style = "text-align:center; vertical-align: middle; overflow: visible; white-space: normal" }).Width(120).ClientTemplate(
                                        "# if(AmountStatus == 1) { #" +
                                       " <span class='fa fa-chevron-up' style='color:red;' id='circle-id'></span> #=kendo.toString(ProposalAmmount, 'c2')#" +
                                       "# } else if(AmountStatus == 2){ #" +
                                       "<span style='color:white;' id='circle-id'> = </span> #=kendo.toString(ProposalAmmount, 'c2')#" +
                                       "# } else { #" +
                                       "#=kendo.toString(ProposalAmmount, 'c2')#" +
                                       "# } #"
                                       );
        }
        else
        {
            //col.Bound(m => m.ProposalAmmount).HtmlAttributes(new { style = "text-align:left;height:30px", onkeydown = "DisableLetters(event)" }).Title("Proposed Amount")
            //.HeaderHtmlAttributes(new { style = "text-align:center; vertical-align: middle; overflow: visible; white-space: normal" })
            //.Width(150);
            col.Template(@<text></text>).HtmlAttributes(new { style = "text-align:right;height:30px;" }).HeaderTemplate(@<text><div style="font-weight:600;text-align:center; vertical-align: middle; overflow: visible; white-space: normal;">Budget Year <span id="proposedYearApprovalBudgetFS"></span> (Proposed)</div></text>)
                                       .HeaderHtmlAttributes(new { style = "text-align:center; vertical-align: middle; overflow: visible; white-space: normal" }).Width(120).ClientTemplate(
                                       "# if(AmountStatus == 1) { #" +
                                       " <span class='fa fa-chevron-up' style='color:red;' id='circle-id'></span> #=kendo.toString(ProposalAmmount, 'c2')#" +
                                       "# } else if(AmountStatus == 2){ #" +
                                       "<span style='color:white;' id='circle-id'> = </span> #=kendo.toString(ProposalAmmount, 'c2')#" +
                                       "# } else { #" +
                                       "#=kendo.toString(ProposalAmmount, 'c2')#" +
                                       "# } #"
                                       );
        }
        if (Account.UserInfo.UserTypeDesc == "Budget Committee / Local Finance Committee" || Account.UserInfo.UserTypeDesc == "Super Admin")
        {
            col.Bound(m => m.SlashAmount).HtmlAttributes(new { style = "text-align:right;height:30px" })
                            .HeaderTemplate(@<text><div style="font-weight:600;text-align:center; vertical-align: middle; overflow: visible; white-space: normal;">Budget Year <br /> <span id="proposedYearApproveBudgetFS"></span> <br /> (Approved)</div></text>)
                        .HeaderHtmlAttributes(new { style = "text-align:center; vertical-align: middle; overflow: visible; white-space: normal" })
                        .Width(150)
                        .ClientTemplate("<div>#=kendo.toString(SlashAmount,'c2')# </div>");
        }
        if (Account.UserInfo.UserTypeDesc == "Budget Committee / Local Finance Committee" || Account.UserInfo.UserTypeDesc == "Super Admin")
        {
            col.Template(t => { }).ClientTemplate(
              "<div class='k-button' onclick='ViewHistoryFS(#=ProposalID#)' style='inline-block' title='View Slashing History Amounts (?)'> <span class='fa fa-history'></span> History</div>")
              .Width(100);
        }
        col.Template(t => { }).ClientTemplate(
            "<div class='k-button' onclick='viewComputationFS(#=AccountCode#)' style='inline-block' title='View Account Computation'> <span class='fa fa-search-plus'></span>Comp.</div>")
            .Width(100);
        col.Bound(m => m.setRemarks)
            .HtmlAttributes(new { style = "text-align:left;height:30px;" }).Title("Remarks")
            .HeaderHtmlAttributes(new { style = "text-align:center; vertical-align: middle; overflow: visible; white-space: normal" }).Width(250);
    })
    @*.ToolBar(toolbar =>
        {
        toolbar.Template(@<text>
            <div style="float: left; height:28px;margin-top:2px;">
                <div id="btnApprove" class="k-button"><i class="fa fa-thumbs-o-up"></i> Approve Marked</div>
                <div id="btnDisapprove" class="k-button"><i class="fa fa-times"></i> Decline Marked</div>
                <div id="btnZimbraEmail" class="k-button"><i class="fa fa-envelope-o"></i> Notify by Zimbra email</div>
            </div>
        </text>);
        })*@
.ToolBar(toolbar =>
             {
                 toolbar.Custom().Text("<span class='fa fa-thumbs-o-up'> </span> Approve Marked").Name("btnApprove").Url("javascript:void(0)").HtmlAttributes(new { onclick = "btnApproveFS()" });
                 toolbar.Save();
             })

                                     .ClientDetailTemplateId("template_table")
                                     .Editable(editable => editable.Mode(GridEditMode.InCell))

                                     .Pageable(page => page.Refresh(true)
                                     .Enabled(true)
                                     .ButtonCount(4)
                                     .PreviousNext(true)
                                         )
                                           .Events(e => e.SaveChanges("reqSave"))
                                           .Selectable()
                                           .DataSource(d => d
                                           .Ajax()
                                           .Batch(true)
                                           .PageSize(10)
                                           .Model(m => m.Id(i => i.AccountID))
                                           .Read(read => read.Action("BudgetAccounts_read_forApproval", "Home").Data("fn_Program"))
                                           .Update("UpdateProposedAccount", "Home"))
)

<script id="template_table" type="text/kendo-tmpl">
    @*<div class="k-button" onclick="AddNewRow('#=AccountID#')"><span class="fa fa-plus-circle"></span> Add New Record</div>
        <div class="k-button" onclick="SaveChanges('#=AccountID#')"><span class="fa fa-check"></span> Save Changes</div>
        <div class="k-button" onclick="CancelChanges('#=AccountID#')"><span class="fa fa-close"></span> Cancel Changes</div>*@
    @(Html.Kendo().Grid<iFMIS_BMS.BusinessLayer.Models.AccountDenomination>()
            .Name("grid_#=AccountID#")
            .HtmlAttributes(new { style = "width:850px;" })
            .Columns(columns =>
            {
                columns.Template(@<text></text>)
                        .HeaderTemplate(@<text>
        <div style="font-weight:600;">Particular Name</div></text>)
                        .HeaderHtmlAttributes(new { style = "text-align:left" })
                        .HeaderHtmlAttributes(new { style = "text-align:center" })
                        .Width(370)
                        .ClientTemplate(
                         "\\# if( isPPMP == 1) { \\# " +
                        "<div> <span class='fa fa-circle' style='color:blue'></span> \\#=DenominationName\\# </div>" +
                        "\\# } else if(isPPMP == 0){ \\#" +
                        "<div>\\#=DenominationName\\# </div>" +
                        "\\# } \\#");
                columns.Bound(e => e.AccountDenominationID).Hidden();
                columns.Template(@<text></text>)
                        .HeaderTemplate(@<text>
        <div style="font-weight:600;">Qty/%</div></text>)
                        .HtmlAttributes(new { style = "text-align:center" })
                        .HeaderHtmlAttributes(new { style = "text-align:center; vertical-align: middle; overflow: visible; white-space: normal" })
                        .ClientTemplate("<div>\\#=kendo.toString(QuantityPercentage)\\# </div>").Width(80);
                columns.Template(@<text></text>)
                        .HeaderTemplate(@<text>
        <div style="font-weight:600;">Months</div></text>)
                        .HtmlAttributes(new { style = "text-align:center" })
                        .HeaderHtmlAttributes(new { style = "text-align:center; vertical-align: middle; overflow: visible; white-space: normal" })
                        .ClientTemplate("<div>\\#=kendo.toString(DenominationMonth)\\# </div>").Width(80);
                columns.Template(@<text></text>)
                        .HeaderTemplate(@<text>
        <div style="font-weight:600;">Rate/Amount</div></text>)
                        .Width(120)
                        .HtmlAttributes(new { style = "text-align:left" })
                        .HeaderHtmlAttributes(new { style = "text-align:left" })
                        .ClientTemplate("<div>\\#=kendo.toString(DenominationAmount, 'c2')\\# </div>");
                columns.Template(@<text></text>)
                        .HeaderTemplate(@<text>
        <div style="font-weight:600;">Total Amount</div></text>)
                        .Width(130)
                        .HtmlAttributes(new { style = "text-align:left" })
                        .HeaderHtmlAttributes(new { style = "text-align:left" })
                        .ClientTemplate("<div>\\#=kendo.toString(TotalDenominationAmount, 'c2')\\# </div>");
                //columns.Bound(e => e.DenominationAmount).Width(150);
            })
.ToolBar(t => t.Template(@<text>
                <div style="float: right; height:28px;margin-top:2px;">

                    <link href="~/Content/metroui/css/docs.css" rel="stylesheet" />
                    @* <div class="k-button" onclick="SubmitDenomination()"><span class="fa fa-cloud-upload"></span> <b>Save Particulars</b></div><div class="k-button" onclick="NewAccountsDenomination('#=AccountID#', '#=ProgramID#', '#=ProposalYear#')"><span class="fa fa-plus-circle"></span> Add New Particular </div> @*<div class="k-button" onclick="SaveChanges('#=AccountID#')"><span class="fa fa-check"></span> Save Changes</div> <div class="k-button" onclick="CancelChanges('#=AccountID#')"><span class="fa fa-close"></span> Cancel Changes</div>*@
                </div>
</text>))

                                                                    .Selectable()
                                                                    .Scrollable()
                                                                    .Pageable(page => page.Refresh(true)
                                                                              .Enabled(true)
                                                                              .ButtonCount(4)
                                                                              .PreviousNext(true))
                                                                    .DataSource(dataSource => dataSource
                                                                        //.Batch(true)
                                                                        .Ajax()
                                                                        //.Aggregates(aggregates => aggregates.Add(m => m.DenominationAmount).Sum())
                                                                        .ServerOperation(false)

                                                                        .PageSize(10)
                                                                        .Model(m =>
                                                                            {
                                                                                m.Id(i => i.AccountDenominationID);

                                                                            })
                                                                                .Read(read => read.Action("Proposal_AccountDenomination", "BudgetPreparation", new { ProgramID = "#=ProgramID#", AccountID = "#=AccountID#", ProposalYear = "#=ProposalYear#", OfficeID = "#=SelectedOfficeID#" }))
                                                                .Destroy(update => update.Action("EditingPopup_Destroy", "Grid"))
                                                                    )
                                                                    .Pageable()
                                                                    .ToClientTemplate()
    )


</script>

<script>

    $(document).ready(function () {

        var BudgetYear = $("#ddlYear").val();
        var PastYear = BudgetYear - 2;
        var CurrentYear = BudgetYear - 1;
        if ("@Account.UserInfo.UserTypeDesc" == "Budget Committee / Local Finance Committee") {
            document.getElementById("proposedYearApproveBudgetFS").innerHTML = BudgetYear;
        }
        document.getElementById("proposedYearApprovalBudgetFS").innerHTML = BudgetYear;
        document.getElementById("actualYearApprovalBudgetFS").innerHTML = PastYear;
        document.getElementById("estimatesYearApprovalBudgetFS").innerHTML = CurrentYear;

        $("#grd_BudgetApprovalBudgetFS").data("kendoGrid").dataSource.read();
    });
</script>